<div class="survey-view">

  <div class="row">

    <div class="col-xs-12">
      <div class="page-header">
        <div *ngIf="survey && survey.conceptId">
          <h2> {{survey.name}} Survey </h2>
          <h4 class="view-sub-title">{{survey.description}} </h4>
        </div>
      </div>
    </div>

  </div>

  <div class="white-card-box">
    <div class="row">
      <div class="col-md-4 col-xs-12">
        <div class="card-stat" *ngIf="!loading">
          {{survey.participantCount | number }}
        </div>
        <div class="box-title participant-count">
          Participants completed this survey
        </div>
      </div>
      <div class="col-md-4 col-xs-12">
        <div class="card-stat">
          <span *ngIf="loading" class="spinner spinner-md"> </span>
          <span *ngIf="!loading" >{{ surveyResult.items.length }} </span>
        </div>
        <h5 class="box-title">
          Questions
        </h5>
      </div>
      <div class="col-md-4 col-xs-12">
        <div class="col-xs-12 flex-xs-middle search-input-full ">
          <div class="row search">
            <div class="col-xs-12 flex-xs-middle search-input-full ">
              <div class="search-wrapper">
                <clr-icon shape="search" class="input-icon-absolute is-info"></clr-icon>
                <input type="text" id="search-db" placeholder="Keyword Search" [formControl]="searchText" autofocus>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-12 flex" *ngIf="searchText.value.length > 0">
          <p class="results-heading no-results" *ngIf="questions.length === 0 && !loading">
          <span *ngIf="searchMethod === 'and'"> No questions match *ALL* keywords: <mark> {{searchText.value}}</mark>.
            <span  class="search-extra"> <button class="btn btn-link" (click)="setSearchMethod('or')">Match any keyword</button> </span>
          </span>
            <span *ngIf="searchMethod === 'or'"> No questions match any of the keywords: <mark> {{searchText.value}}</mark>.
            <span  class="search-extra"> <button class="btn btn-link" (click)="setSearchMethod('or', true)">Reset search</button></span>
          </span>
          </p>
          <p class="results-heading" *ngIf="questions.length > 0 && !loading">
          <span *ngIf="searchMethod==='or'" >
            <b> {{questions.length}} </b> questions match <b>*ANY*</b> keyword: <mark>{{searchText.value}}</mark>.
            <button class="btn btn-link" (click)="setSearchMethod('and')">Match all keywords</button>
          </span>
            <span *ngIf="searchMethod==='and'" >
            <span> <b> {{questions.length}} </b> questions match <b>*ALL*</b> keywords: <mark>{{searchText.value}}</mark>.</span>
            <button class="btn btn-link" (click)="setSearchMethod('or')">Match any keyword</button>
          </span>
          </p>
        </div>
      </div>
    </div>
    <div class="row survey-pdf-url">
      <div class="col-md-4 col-xs-12">
        <div class="card-text">
          <a href="{{surveyPdfUrl}}" download> <clr-icon shape="file" class="has-badge is-solid"></clr-icon> Download Survey as PDF</a>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 col-xs-12">
        <p card-text>Click on each response to view branding logic and age and gender distributions</p>
      </div>
    </div>
    <div class="survey-results" *ngIf="resultsComplete">
      <div class="row question-result" *ngFor="let q of questions, let i = index">

        <div class="row question">
          <div class="col-md-12 col-xs-12">
            <div class="box-title"> Question {{i + 1}}</div>
            <div class="box-sub-title question-display">
              <div class="box-sub-title question question">
                <app-highlight-search [text]="q.conceptName" [searchTerm]="searchText.value" [conceptId]="q.conceptId"></app-highlight-search>
              </div>
            </div>
          </div>
          <div class="col-xs-12">
            <a class="toggle-link" (click)="toggleAnswer(q.conceptId)" *ngIf="q.subQuestions === null; else subQuestionLink"> See Answers
              <clr-icon *ngIf="!showAnswer[q.conceptId]" shape="caret" dir="right"></clr-icon> <clr-icon *ngIf="showAnswer[q.conceptId]" shape="caret" dir="down"></clr-icon> </a>
            <ng-template #subQuestionLink>
              <a class="toggle-link" (click)="toggleAnswer(q.conceptId)"> See Sub Questions
                <clr-icon *ngIf="!showAnswer[q.conceptId]" shape="caret" dir="right"></clr-icon> <clr-icon *ngIf="showAnswer[q.conceptId]" shape="caret" dir="down"></clr-icon> </a>
            </ng-template>
          </div>
        </div>
        <div class="row col-xs-12 col-header-row" [hidden]="!showAnswer[q.conceptId]">
          <div class="col-md-5 info-text">
            Text
          </div>
          <div class="col-md-2 info-text">
            Concept Code
            <clr-tooltip>
              <clr-icon clrTooltipTrigger shape="info-standard" class="is-solid info-icon"></clr-icon>
              <clr-tooltip-content clrPosition=bottom-left
                                   clrSize="lg" *clrIfOpen>
                <div class="tooltip-label">The concept code is an additional piece of information that
                  can be utilized to find medical concepts in the All of Us data set. Concept codes are specific to the
                  All of Us Research Program data and are assigned to all medical concepts.
                  In some instances,
                  a medical concept may not be assigned a source or standard vocabulary code.
                  In these instances, the concept code can be utilized to
                  query the data for the medical concept.</div>
              </clr-tooltip-content>
            </clr-tooltip>
          </div>
          <div class="col-md-2 info-text">
            Participant Count
          </div>
          <div class="col-md-2 info-text flex-xs-middle">
            % answered
          </div>
          <div class="col-md-1 info-text">
          </div>
        </div>
        <ng-container *ngIf="q.subQuestions === null; else subQuestionDisplay">
          <div class="row expandable-grid-row" *ngFor="let a of q.countAnalysis.results" [hidden]="!showAnswer[q.conceptId]">
            <div class="col-md-6 flex-xs-middle" *ngIf="!binnedSurveyQuestions.includes(a.stratum2); else binnedSurveyQuestionDisplay">
              <label class="answer-text">
                <app-highlight-search [text]="a.stratum4" [searchTerm]="searchText.value"></app-highlight-search>
              </label>
            </div>
            <ng-template #binnedSurveyQuestionDisplay>
              <div class="col-md-6 flex-xs-middle">
                <label class="answer-text" *ngIf="a.stratum4.toLowerCase().trim() === 'did not answer' || a.stratum4.toLowerCase().includes('skip'); else rangeLabel">
                  <app-highlight-search [text]="a.stratum4" [searchTerm]="searchText.value"></app-highlight-search>
                </label>
                <ng-template #rangeLabel>
                  <label class="answer-text">
                    <app-highlight-search [text]="a.stratum4 + '-' + (convertToNum(a.stratum4)+10)" [searchTerm]="searchText.value"></app-highlight-search>
                  </label>
                </ng-template>
              </div>
            </ng-template>
            <div class="col-md-2 flex-xs-middle">
              <label class="concept-code">{{a.stratum3}}</label>
            </div>
            <div class="answer-text col-md-2 flex-xs-middle">
              <label class="participant-count answer-text">{{a.countValue | number}}  </label>
            </div>
            <div class="col-md-1 percent-bar flex-xs-middle">
              <span>{{a.countPercent.toFixed(2)}}%</span>
            </div>
            <div class="col-md-1 flex-xs-middle">
              <button class="icon-btn" (click)="showAnswerGraphs(a)">
                <clr-icon shape="bar-chart" style="height: 1rem; width: 1rem;color: #2691D0;"></clr-icon>
              </button>
            </div>
            <div class="col-xs-12 row-expansion flex-xs-middle" *ngIf="a.expanded && a.stratum4.toLowerCase() != 'did not answer'" #chartElement>
              <button *ngFor="let g of ['Biological Sex', 'Gender Identity', 'Age at Occurrence']" [ngClass]="{active:selectedGraph === g}" (click)="selectGraph(g,q)" class="btn btn-link">{{g}}</button>
              <div class="row">
                <div class="col-md-4"></div>
                <div class="col-md-4">
                  <app-chart [analysis]="q.selectedAnalysis" [selectedResult]="a" [backgroundColor]="'#ECF1F4'" [domainType]="'surveys'"></app-chart>
                </div>
                <div class="col-md-4"></div>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #subQuestionDisplay>
          <div class="row expandable-grid-row sub-question" *ngFor="let sq of q.subQuestions" [ngClass]="{'expanded-row': sq.expanded}" [hidden]="!showAnswer[q.conceptId]">
            <div class="col-md-5 flex-xs-middle">{{sq.conceptName}}</div>
            <div class="col-md-2 flex-xs-middle">{{sq.conceptId}}</div>
            <div class="col-md-2 flex-xs-middle">{{sq.countValue}}</div>
            <div class="col-md-2 flex-xs-middle">{{countPercentage(sq.countValue).toFixed(2)}}</div>
            <div class="col-md-1 flex-xs-middle">
              <a class="toggle-link" (click)="sq.expanded = !sq.expanded"> See Answers
                <clr-icon *ngIf="!showAnswer[sq.conceptId]" shape="caret" dir="right"></clr-icon> <clr-icon *ngIf="showAnswer[sq.conceptId]" shape="caret" dir="down"></clr-icon> </a>
            </div>
            <div class="row expandable-grid-row sub-question-results flex-xs-middle" *ngFor="let a of sq.countAnalysis.results" [hidden]="!sq.expanded">
              <div class="col-md-5 flex-xs-middle">{{removeDescribingWords(a.stratum4)}}</div>
              <div class="col-md-2 flex-xs-middle">{{a.stratum3}}</div>
              <div class="col-md-2 flex-xs-middle">{{a.countValue | number}}</div>
              <div class="col-md-2 flex-xs-middle">{{countPercentage(a.countValue).toFixed(2)}}%</div>
              <div class="col-md-1 flex-xs-middle">
                <button class="icon-btn" (click)="showAnswerGraphs(a, sq)">
                  <clr-icon shape="bar-chart" style="height: 1rem; width: 1rem;color: #2691D0;"></clr-icon>
                </button>
              </div>
              <div class="col-xs-12 row-expansion flex-xs-middle" *ngIf="a.expanded && a.stratum4.toLowerCase() != 'did not answer'" #chartElement>
                <button *ngFor="let g of ['Biological Sex', 'Gender Identity', 'Age at Occurrence']" [ngClass]="{active:selectedGraph === g}" (click)="selectGraph(g,sq)" class="btn btn-link">{{g}}</button>
                <div class="row">
                  <div class="col-md-4"></div>
                  <div class="col-md-4">
                    <app-chart [analysis]="sq.selectedAnalysis" [selectedResult]="a" [backgroundColor]="'#ECF1F4'" [domainType]="'surveys'"></app-chart>
                  </div>
                  <div class="col-md-4"></div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>

      </div>
    </div>
  </div>


  <!-- Todo show general totals for demographics of who took the survey -->
  <!--
  <div class="row">
    <div class="col-xs-12">
      <app-concept-charts [concept]="survey" [showRace]="true" [showAge]="true" [showGender]="true"
                        [showEthnicity]="true" [backgroundColor]="'#ECF1F4'">
      </app-concept-charts>
    </div>
  </div>
  -->
  <div class="info-text"> Note: The survey questions appear in the order in which people actually took the survey.</div>

</div>