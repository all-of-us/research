#!/usr/bin/env ruby

require 'fileutils'
require_relative "../../aou-utils/workbench"

def build_snippets_menu()
  tmpl = File.read("aou-snippets-menu.js.template")
  tmpl = "/* " + ("=" * 20) +
         " This file is autogenerated, DO NOT MODIFY MANUALLY " +
         ("=" * 20) + " */\n" + tmpl

  {
    "{{PY_DATASET_MENU_JSON}}" => "py-dataset-snippets-menu.json",
    "{{PY_GCS_MENU_JSON}}" => "py-gcs-snippets-menu.json",
    "{{PY_SQL_MENU_JSON}}" => "py-sql-snippets-menu.json",
    "{{R_DATASET_MENU_JSON}}" => "r-dataset-snippets-menu.json",
    "{{R_GCS_MENU_JSON}}" => "r-gcs-snippets-menu.json",
    "{{R_SQL_MENU_JSON}}" => "r-sql-snippets-menu.json",
  }.each do |var, path|
    # Ruby apparently lacks a basic string replacement function. sub/gsub
    # support pattern inputs and captures, and \ interacts poorly with output
    # captures. Replace manually.
    i = tmpl.index(var)
    tmpl.sub! var, ''
    tmpl = tmpl.insert i, File.read(path)
  end

  FileUtils.mkdir_p "generated"
  File.write("generated/aou-snippets-menu.js", tmpl)
end

Common.register_command({
  :invocation => "build-snippets-menu",
  :description => "Builds the templated snippets menu Jupyter extension",
  :fn => ->() { build_snippets_menu }
})

def generate_static_files()
  static_files_directory = "../src/main/webapp/static"
  FileUtils.cp("activity-checker-extension.js", static_files_directory)
  FileUtils.cp("aou-download-policy-extension.js", static_files_directory)
  FileUtils.cp("initialize_notebook_cluster.sh", static_files_directory)
  FileUtils.cp("start_notebook_cluster.sh", static_files_directory)
  build_snippets_menu()
  FileUtils.mkdir_p static_files_directory + "/generated"
  FileUtils.cp("generated/aou-snippets-menu.js", static_files_directory + "/generated")
end

Common.register_command({
  :invocation => "generate-static-files",
  :description => "Copies files from the cluster resources directory into our static files",
  :fn => ->() { generate_static_files }
})

Workbench.handle_argv_or_die(__FILE__)
