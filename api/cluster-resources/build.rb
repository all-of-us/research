#!/usr/bin/env ruby

require 'fileutils'
require_relative "../../aou-utils/workbench"

def build_snippets_menu()
  tmpl = File.read("aou-snippets-menu.js.template")
  tmpl = "/* " + ("=" * 20) +
         " This file is autogenerated, DO NOT MODIFY MANUALLY " +
         ("=" * 20) + " */\n" + tmpl

  {
    "{{PY_DATASET_MENU_JSON}}" => "py_dataset_snippets_menu_config.json",
    "{{PY_GCS_MENU_JSON}}" => "py_gcs_snippets_menu_config.json",
    "{{PY_SQL_MENU_JSON}}" => "py_sql_snippets_menu_config.json",
    "{{R_DATASET_MENU_JSON}}" => "r_dataset_snippets_menu_config.json",
    "{{R_GCS_MENU_JSON}}" => "r_gcs_snippets_menu_config.json",
    "{{R_SQL_MENU_JSON}}" => "r_sql_snippets_menu_config.json",
  }.each do |var, path|
    # Ruby apparently lacks a basic string replacement function. sub/gsub
    # support pattern inputs and captures, and \ interacts poorly with output
    # captures. Replace manually.
    i = tmpl.index(var)
    tmpl.sub! var, ''
    tmpl = tmpl.insert i, File.read(path)
  end

  FileUtils.mkdir_p "generated"
  File.write("generated/aou-snippets-menu.js", tmpl)
end

Common.register_command({
  :invocation => "build-snippets-menu",
  :description => "Builds the templated snippets menu Jupyter extension",
  :fn => ->() { build_snippets_menu }
})

Workbench.handle_argv_or_die(__FILE__)
