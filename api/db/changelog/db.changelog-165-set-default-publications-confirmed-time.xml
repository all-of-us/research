<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
  <changeSet author="psantos-dmohs" id="changelog-165-set-default-publications-confirmed-time">
    <addDefaultValue tableName="user" columnName="publications_last_confirmed_time" defaultValue="CURRENT_TIMESTAMP"/>

    <sql>
      -- migration copied from 162
      UPDATE user u
      INNER JOIN user_access_tier uat ON u.user_id = uat.user_id
      INNER JOIN access_tier a ON uat.access_tier_id = a.access_tier_id

      SET
      u.publications_last_confirmed_time = uat.first_enabled
      WHERE u.publications_last_confirmed_time is null
    </sql>

    <addNotNullConstraint
            columnName="publications_last_confirmed_time"
            tableName="user"/>
  </changeSet>
</databaseChangeLog>