<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">


  <changeSet author="biopete" id="changelog-3.1 achilles results keys and views" >
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="ACHILLES_results" schemaName="cdr" />
    </preConditions>




    <dropPrimaryKey tableName="ACHILLES_results"/>
    <dropPrimaryKey tableName="ACHILLES_results_dist"/>

    <addColumn schemaName="cdr" tableName="ACHILLES_results" >
      <column name="id" type="BIGINT" autoIncrement="true">
          <constraints primaryKey="true" nullable="false" />
      </column>
    </addColumn>

    <addColumn schemaName="cdr" tableName="ACHILLES_results_dist">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" />
      </column>
    </addColumn>

    <createIndex
            indexName="idx_results_analysis_id"
            tableName="ACHILLES_results"
            unique="false">
      <column name="analysis_id"/>
      <column name="stratum_1"/>
    </createIndex>


    <createIndex
            indexName="idx_dist_analysis_id"
            tableName="ACHILLES_results_dist"
            unique="false">
      <column name="analysis_id"/>
      <column name="stratum_1"/>

    </createIndex>
    <createIndex
            indexName="idx_strat2_results_analysis_id"
            tableName="ACHILLES_results"
            unique="false">
      <column name="stratum_2"/>
    </createIndex>
    <createIndex
            indexName="idx_strat2_dist_results_analysis_id"
            tableName="ACHILLES_results_dist"
            unique="false">
      <column name="stratum_2"/>
    </createIndex>

    <createView replaceIfExists="true" schemaName="cdr" viewName="ACHILLES_results_view">
      SELECT
      `a`.id AS `id`,
      `a`.`analysis_id` AS `analysis_id`,
      `a`.`count_value` AS `count_value`,
      `a`.`stratum_1` AS `stratum_1`,
      `c1`.`concept_name` AS `stratum_1_name`,
      `a`.`stratum_2` AS `stratum_2`,
      `c2`.`concept_name` AS `stratum_2_name`,
      `a`.`stratum_3` AS `stratum_3`,
      `c3`.`concept_name` AS `stratum_3_name`,
      `a`.`stratum_4` AS `stratum_4`,
      `c4`.`concept_name` AS `stratum_4_name`,
      `a`.`stratum_5` AS `stratum_5`,
      `c5`.`concept_name` AS `stratum_5_name`
      FROM (((((`ACHILLES_results` `a`
      left join `concept` `c1` on((`a`.`stratum_1` = `c1`.`concept_id`)))
      left join `concept` `c2` on((`a`.`stratum_2` = `c2`.`concept_id`)))
      left join `concept` `c3` on((`a`.`stratum_3` = `c3`.`concept_id`)))
      left join `concept` `c4` on((`a`.`stratum_4` = `c4`.`concept_id`)))
      left join `concept` `c5` on((`a`.`stratum_5` = `c5`.`concept_id`)))
    </createView>
    <createView replaceIfExists="true" schemaName="cdr" viewName="ACHILLES_results_dist_view">
      SELECT
      `a`.id AS `id`,
      `a`.`analysis_id` AS `analysis_id`,
      `a`.`count_value` AS `count_value`,
      `a`.`stratum_1` AS `stratum_1`,
      `c1`.`concept_name` AS `stratum_1_name`,
      `a`.`stratum_2` AS `stratum_2`,
      `c2`.`concept_name` AS `stratum_2_name`,
      `a`.`stratum_3` AS `stratum_3`,
      `c3`.`concept_name` AS `stratum_3_name`,
      `a`.`stratum_4` AS `stratum_4`,
      `c4`.`concept_name` AS `stratum_4_name`,
      `a`.`stratum_5` AS `stratum_5`,
      `c5`.`concept_name` AS `stratum_5_name`,
      `a`.`min_value` AS `min_value`,
      `a`.`max_value` AS `max_value`,
      `a`.`avg_value` AS `avg_value`,
      `a`.`stdev_value` AS `stdev_value`,
      `a`.`median_value` AS `median_value`,
      `a`.`p10_value` AS `p10_value`,
      `a`.`p25_value` AS `p25_value`,
      `a`.`p75_value` AS `p75_value`,
      `a`.`p90_value` AS `p90_value`
      FROM (((((`ACHILLES_results_dist` `a`
      left join `concept` `c1` on((`a`.`stratum_1` = `c1`.`concept_id`)))
      left join `concept` `c2` on((`a`.`stratum_2` = `c2`.`concept_id`)))
      left join `concept` `c3` on((`a`.`stratum_3` = `c3`.`concept_id`)))
      left join `concept` `c4` on((`a`.`stratum_4` = `c4`.`concept_id`)))
      left join `concept` `c5` on((`a`.`stratum_5` = `c5`.`concept_id`)))
    </createView>
  </changeSet>

</databaseChangeLog>
