<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
  <changeSet author="biopete" id="changelog-13" runAlways="true" context="local or cloud">

    <validCheckSum>ANY</validCheckSum>

    <delete tableName="achilles_results"/>

    <loadData tableName="achilles_results" file="csv/ACHILLES_results.csv" encoding="UTF-8" quotchar='"'>
      <column name="analysis_id" type="NUMERIC"/>
      <column name="stratum_1" type="STRING"/>
      <column name="stratum_2" type="STRING"/>
      <column name="stratum_3" type="STRING"/>
      <column name="stratum_4" type="STRING"/>
      <column name="stratum_5" type="STRING"/>
      <column name="count_value" type="NUMERIC"/>
    </loadData>

  </changeSet>

  <changeSet author="biopete" id="changelog-13.1 fill achilles_results_concept">
    <sql
            splitStatements="true"
            stripComments="true">INSERT INTO achilles_results_concept
            SELECT
            `a`.id AS `id`,
            `a`.`analysis_id` AS `analysis_id`,
            `a`.`stratum_1` AS `stratum_1`,
            `c1`.`concept_name` AS `stratum_1_name`,
            `a`.`stratum_2` AS `stratum_2`,
            `c2`.`concept_name` AS `stratum_2_name`,
            `a`.`stratum_3` AS `stratum_3`,
            `c3`.`concept_name` AS `stratum_3_name`,
            `a`.`stratum_4` AS `stratum_4`,
            `c4`.`concept_name` AS `stratum_4_name`,
            `a`.`stratum_5` AS `stratum_5`,
            `c5`.`concept_name` AS `stratum_5_name`,
            `a`.`count_value` AS `count_value`
            FROM (((((`achilles_results` `a`
            left join `concept` `c1` on((`a`.`stratum_1` = `c1`.`concept_id`)))
            left join `concept` `c2` on((`a`.`stratum_2` = `c2`.`concept_id`)))
            left join `concept` `c3` on((`a`.`stratum_3` = `c3`.`concept_id`)))
            left join `concept` `c4` on((`a`.`stratum_4` = `c4`.`concept_id`)))
            left join `concept` `c5` on((`a`.`stratum_5` = `c5`.`concept_id`)))

      <comment>Populate the achilles_results_concept table for api </comment>
    </sql>
  </changeSet>
</databaseChangeLog>
